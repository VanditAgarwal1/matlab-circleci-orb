description: >
  Execute MATLAB script, statement, or function. MATLAB exits with exit code 0 if the command
  executes successfully. Otherwise, MATLAB terminates with a non-zero exit code.

parameters:
  command:
    description: >
      Script, statement, or function to execute. If the command is the name of a MATLAB function or
      script, do not specify the file extension. Any required file must be on the MATLAB search path
      or in the startup folder.
    type: string

  startup-folder:
    description: >
      Current folder when MATLAB starts. Defaults to the current working folder.
    type: string
    default: .

steps:
  - run:
      name: Run MATLAB command
      command: |
        tmpdir=$(mktemp -d 2>/dev/null || mktemp -d -t 'run-command')

        # write command to file to better support YAML literal blocks
        cmdscript=$(mktemp -u cmd_XXXXXXXXXX)
        cat > "${tmpdir}/${cmdscript}.m" \<<EOF
        <<parameters.command>>
        EOF

        # download helper toolbox
        wget -q -O "${tmpdir}/ci_helpers.mltbx" https://github.com/mcafaro/ci-helpers/releases/download/v0.0.1/ci_helpers.mltbx

        # execute MATLAB command in batch mode
        matlab -sd "<<parameters.startup-folder>>" -batch "\
          matlab.addons.toolbox.installToolbox('${tmpdir}/ci_helpers.mltbx');\
          cihelpers.run('${tmpdir}/${cmdscript}')"
