description: >
  Run all tests in your project.

parameters:
  test-results-junit:
    description: >
      Path to write test results report using JUnit XML format.
    type: string
    default: ''
  code-coverage-cobertura:
    description: >
      Path to write code coverage report using Cobertura XML format.
    type: string
    default: ''
  source-folder:
    description: >
      Location of the folder containing source code, relative to the project root folder. The
      specified folder and its subfolders will be added to the top of the MATLAB search path. To
      generate a code coverage report, MATLAB uses only the source code in the specified folder and
      its subfolders. You can specify multiple folders using a colon-separated or a
      semicolon-separated list.
    type: string
    default: ''

steps:
  - run:
      name: Run MATLAB tests
      command: |
        tmpdir=$(mktemp -d 2>/dev/null || mktemp -d -t 'run-tests')

        # download run command shell scripts
        wget -qO "${tmpdir}/bin.zip" https://ssd.mathworks.com/supportfiles/ci/run-matlab-command/v0/run-matlab-command.zip
        unzip -qod "${tmpdir}/bin" "${tmpdir}/bin.zip"

        # download script generator
        wget -qO "${tmpdir}/scriptgen.zip" https://ssd.mathworks.com/supportfiles/ci/matlab-script-generator/v0/matlab-script-generator.zip
        unzip -qod "${tmpdir}/scriptgen" "${tmpdir}/scriptgen.zip"

        # generate and run MATLAB test script
        "${tmpdir}/bin/run_matlab_command.sh" "\
          addpath('${tmpdir}/scriptgen');\
          testScript = genscript('Test','WorkingFolder','..',\
            'JUnitTestResults','<<parameters.test-results-junit>>',\
            'CoberturaCodeCoverage','<<parameters.code-coverage-cobertura>>',\
            'SourceFolder','<<parameters.source-folder>>');\
          scriptFile = testScript.writeToFile('.matlab/runAllTests.m');\
          disp(['Running ''' scriptFile ''':']);\
          type(scriptFile);\
          fprintf('__________\n\n');\
          cd('.matlab');\
          runAllTests;"
