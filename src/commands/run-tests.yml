description: >
  Run all tests in your project.

parameters:
  test-results-junit:
    description: >
      Path to write test results report using JUnit XML format.
    type: string
    default: ""

steps:
  - run:
      name: Run MATLAB tests
      command: |
        tmpdir=$(mktemp -d 2>/dev/null || mktemp -d -t 'run-tests')

        # download run command shell scripts
        wget -q -O "${tmpdir}/bin.zip" https://storage.googleapis.com/matlabimagesus/public/run-matlab-command/v0/run-matlab-command.zip
        unzip -q -d "${tmpdir}/bin" "${tmpdir}/bin.zip"

        # download MATLAB script generator
        wget -q -O "${tmpdir}/scriptgen.zip" https://storage.googleapis.com/matlabimagesus/public/matlab-script-generator/v0/matlab-script-generator.zip
        unzip -q -d "${tmpdir}/scriptgen" "${tmpdir}/scriptgen.zip"

        # generate and run MATLAB test script
        "${tmpdir}/bin/run_matlab_command.sh" "\
          addpath('${tmpdir}/scriptgen');\
          testScript = genscript('Test', 'JUnitTestResults', '<<parameters.test-results-junit>>');\
          run(testScript.writeToFile('mw/runAllTests.m'));"
